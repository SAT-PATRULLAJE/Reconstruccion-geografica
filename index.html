<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
  <title>Análisis de Trayectoria Forense</title>
  <style>
    :root{--panel-bg:rgba(255,255,255,.96);--shadow:0 8px 24px rgba(0,0,0,.15);--radius:14px;--gap:10px;--font:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    html,body{height:100%;margin:0;font-family:var(--font)}
    #map{height:100%;width:100%}
    .ui{position:absolute;inset:12px 12px auto 12px;z-index:2;background:var(--panel-bg);backdrop-filter:blur(4px);border-radius:var(--radius);box-shadow:var(--shadow);padding:12px;max-width:420px}
    @media (max-width:680px){.ui{inset:auto 10px 10px 10px;max-width:none;width:auto}}
    h3{margin:0 0 8px;font-size:16px}
    .row{display:grid;grid-template-columns:1fr auto;gap:8px;align-items:center;margin:8px 0}
    .kpi{font-weight:700}
    input[type="range"]{width:100%}
    .controls{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0}
    .controls button,.controls select{border-radius:10px;padding:8px 10px;border:1px solid #ddd;background:#fff;cursor:pointer}
    .legend{display:flex;gap:12px;flex-wrap:wrap;font-size:12px;margin:6px 0 8px}
    .dot{width:10px;height:10px;border-radius:50%;display:inline-block;margin-right:6px;vertical-align:middle}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:var(--gap)}
    @media (max-width:480px){.grid{grid-template-columns:1fr}}
    .card{border:1px solid #eaeaea;border-radius:12px;padding:10px;background:#fff;font-size:12px;line-height:1.25}
    .badge{font-size:11px;opacity:.85;margin-top:8px}
    .float-note{position:absolute;z-index:2;right:12px;bottom:12px;background:var(--panel-bg);border-radius:10px;padding:6px 10px;box-shadow:var(--shadow);font-size:12px;display:none}
  </style>

  
  <script>
    window.__initMapReal=null;window.__initMapPending=false;
    window.initMap=function(){if(typeof window.__initMapReal==='function'){try{window.__initMapReal()}catch(e){console.error('initMapReal error:',e)}}else{window.__initMapPending=true}};
  </script>

  
  <script id="TRAY_JSON" type="application/json">[{"lat":-32.865215,"lng":-68.843483,"fecha":"2024-08-14T13:00:00.000Z","fechaEpoch":1723640400000,"velocidad":29,"odometro":"538632,2 km","lugar":"Belgrano y Damián Hudson (Capital, Mendoza)","esImpacto":false},{"lat":-32.8663826,"lng":-68.8438161,"fecha":"2024-08-14T13:00:00.000Z","fechaEpoch":1723640400000,"velocidad":0,"odometro":"538632,3 km","lugar":"Damián Hudson y Francisco Rubilar (Capital, Mendoza)","esImpacto":true},{"lat":-32.8665941,"lng":-68.8438756,"fecha":"2024-08-14T13:00:00.000Z","fechaEpoch":1723640400000,"velocidad":21,"odometro":"538632,4 km","lugar":"Damián Hudson y Francisco Rubilar (Capital, Mendoza)","esImpacto":false},{"lat":-32.8685813,"lng":-68.844368,"fecha":"2024-08-14T13:01:00.000Z","fechaEpoch":1723640460000,"velocidad":28,"odometro":"538632,6 km","lugar":"Jorge A. Calle y Miguel E. Soler (Capital, Mendoza)","esImpacto":false},{"lat":-32.870103,"lng":-68.8447933,"fecha":"2024-08-14T13:01:00.000Z","fechaEpoch":1723640460000,"velocidad":0,"odometro":"538632,8 km","lugar":"Leopoldo Lugones y Videla Correa (Capital, Mendoza)","esImpacto":true},{"lat":-32.8702801,"lng":-68.8448438,"fecha":"2024-08-14T13:02:00.000Z","fechaEpoch":1723640520000,"velocidad":21,"odometro":"538632,8 km","lugar":"Leopoldo Lugones y Videla Correa (Capital, Mendoza)","esImpacto":false},{"lat":-32.8719353,"lng":-68.8452841,"fecha":"2024-08-14T13:02:00.000Z","fechaEpoch":1723640520000,"velocidad":19,"odometro":"538633,0 km","lugar":"José Hernández y Moreno Belgrano (Capital, Mendoza)","esImpacto":false},{"lat":-32.8737835,"lng":-68.8457773,"fecha":"2024-08-14T13:03:00.000Z","fechaEpoch":1723640580000,"velocidad":28,"odometro":"538633,2 km","lugar":"Carlos Pellegrini y Tiburcio Benegas (Capital, Mendoza)","esImpacto":false},{"lat":-32.875956,"lng":-68.8464156,"fecha":"2024-08-14T13:03:00.000Z","fechaEpoch":1723640580000,"velocidad":34,"odometro":"538633,4 km","lugar":"Belgrano y Francisco Narciso Laprida (Capital, Mendoza)","esImpacto":false},{"lat":-32.8761448,"lng":-68.8464596,"fecha":"2024-08-14T13:03:00.000Z","fechaEpoch":1723640580000,"velocidad":25,"odometro":"538633,5 km","lugar":"Belgrano y Francisco Narciso Laprida (Capital, Mendoza)","esImpacto":false},{"lat":-32.8761983,"lng":-68.8464658,"fecha":"2024-08-14T13:03:00.000Z","fechaEpoch":1723640580000,"velocidad":21,"odometro":"538633,5 km","lugar":"Belgrano y Coronel J. Moldes (Capital, Mendoza)","esImpacto":false},{"lat":-32.8763005,"lng":-68.8464818,"fecha":"2024-08-14T13:03:00.000Z","fechaEpoch":1723640580000,"velocidad":19,"odometro":"538633,5 km","lugar":"Belgrano y Coronel J. Moldes (Capital, Mendoza)","esImpacto":false},{"lat":-32.8763358,"lng":-68.846494,"fecha":"2024-08-14T13:03:00.000Z","fechaEpoch":1723640580000,"velocidad":15,"odometro":"538633,5 km","lugar":"Belgrano y Coronel J. Moldes (Capital, Mendoza)","esImpacto":false},{"lat":-32.8763721,"lng":-68.8465013,"fecha":"2024-08-14T13:03:00.000Z","fechaEpoch":1723640580000,"velocidad":13,"odometro":"538633,5 km","lugar":"Belgrano y Coronel J. Moldes (Capital, Mendoza)","esImpacto":false},{"lat":-32.8764041,"lng":-68.8465008,"fecha":"2024-08-14T13:03:00.000Z","fechaEpoch":1723640580000,"velocidad":11,"odometro":"538633,5 km","lugar":"Belgrano y Coronel J. Moldes (Capital, Mendoza)","esImpacto":false},{"lat":-32.8764235,"lng":-68.8465038,"fecha":"2024-08-14T13:03:00.000Z","fechaEpoch":1723640580000,"velocidad":7,"odometro":"538633,5 km","lugar":"Belgrano y Coronel J. Moldes (Capital, Mendoza)","esImpacto":false},{"lat":-32.8764446,"lng":-68.8465023,"fecha":"2024-08-14T13:03:00.000Z","fechaEpoch":1723640580000,"velocidad":0,"odometro":"538633,5 km","lugar":"Belgrano y Coronel J. Moldes (Capital, Mendoza)","esImpacto":true},{"lat":-32.8766795,"lng":-68.8465655,"fecha":"2024-08-14T13:04:00.000Z","fechaEpoch":1723640640000,"velocidad":21,"odometro":"538633,5 km","lugar":"Belgrano y Coronel J. Moldes (Capital, Mendoza)","esImpacto":false},{"lat":-32.8790545,"lng":-68.8472105,"fecha":"2024-08-14T13:04:00.000Z","fechaEpoch":1723640640000,"velocidad":21,"odometro":"538633,8 km","lugar":"Suipacha y Coronel P. Plaza (Capital, Mendoza)","esImpacto":false},{"lat":-32.8793891,"lng":-68.847257,"fecha":"2024-08-14T13:05:00.000Z","fechaEpoch":1723640700000,"velocidad":0,"odometro":"538633,8 km","lugar":"Suipacha y Coronel P. Plaza (Capital, Mendoza)","esImpacto":true},{"lat":-32.8794975,"lng":-68.8472571,"fecha":"2024-08-14T13:06:00.000Z","fechaEpoch":1723640760000,"velocidad":10,"odometro":"538633,9 km","lugar":"Suipacha y Coronel P. Plaza (Capital, Mendoza)","esImpacto":false},{"lat":-32.8809006,"lng":-68.8476835,"fecha":"2024-08-14T13:06:00.000Z","fechaEpoch":1723640760000,"velocidad":20,"odometro":"538634,0 km","lugar":"Lorenzo Barcala y Perú (Capital, Mendoza)","esImpacto":false},{"lat":-32.882449,"lng":-68.8481366,"fecha":"2024-08-14T13:07:00.000Z","fechaEpoch":1723640820000,"velocidad":20,"odometro":"538634,2 km","lugar":"Villalonga (Capital, Mendoza)","esImpacto":false},{"lat":-32.8829048,"lng":-68.8482443,"fecha":"2024-08-14T13:07:00.000Z","fechaEpoch":1723640820000,"velocidad":10,"odometro":"538634,3 km","lugar":"Villalonga (Capital, Mendoza)","esImpacto":false},{"lat":-32.8829245,"lng":-68.8482441,"fecha":"2024-08-14T13:07:00.000Z","fechaEpoch":1723640820000,"velocidad":6,"odometro":"538634,3 km","lugar":"Villalonga (Capital, Mendoza)","esImpacto":false},{"lat":-32.8829385,"lng":-68.8482541,"fecha":"2024-08-14T13:07:00.000Z","fechaEpoch":1723640820000,"velocidad":6,"odometro":"538634,3 km","lugar":"Villalonga (Capital, Mendoza)","esImpacto":false},{"lat":-32.8829455,"lng":-68.8482545,"fecha":"2024-08-14T13:07:00.000Z","fechaEpoch":1723640820000,"velocidad":5,"odometro":"538634,3 km","lugar":"Villalonga (Capital, Mendoza)","esImpacto":false},{"lat":-32.8829445,"lng":-68.8482531,"fecha":"2024-08-14T13:07:00.000Z","fechaEpoch":1723640820000,"velocidad":3,"odometro":"538634,3 km","lugar":"Villalonga (Capital, Mendoza)","esImpacto":false},{"lat":-32.8829398,"lng":-68.8482586,"fecha":"2024-08-14T13:07:00.000Z","fechaEpoch":1723640820000,"velocidad":2,"odometro":"538634,3 km","lugar":"Villalonga (Capital, Mendoza)","esImpacto":false},{"lat":-32.8828985,"lng":-68.8483105,"fecha":"2024-08-14T13:07:00.000Z","fechaEpoch":1723640820000,"velocidad":0,"odometro":"538634,3 km","lugar":"Villalonga (Capital, Mendoza)","esImpacto":true},{"lat":-32.882965,"lng":-68.8483781,"fecha":"2024-08-14T13:08:00.000Z","fechaEpoch":1723640880000,"velocidad":19,"odometro":"538634,3 km","lugar":"Villalonga (Capital, Mendoza)","esImpacto":false},{"lat":-32.8830148,"lng":-68.848345,"fecha":"2024-08-14T13:08:00.000Z","fechaEpoch":1723640880000,"velocidad":21,"odometro":"538634,3 km","lugar":"Villalonga (Capital, Mendoza)","esImpacto":false},{"lat":-32.8841231,"lng":-68.8485351,"fecha":"2024-08-14T13:08:00.000Z","fechaEpoch":1723640880000,"velocidad":11,"odometro":"538634,4 km","lugar":"Manuel Belgrano y Av. Juan Bautista Justo (Capital, Mendoza)","esImpacto":false},{"lat":-32.8841535,"lng":-68.8485371,"fecha":"2024-08-14T13:08:00.000Z","fechaEpoch":1723640880000,"velocidad":9,"odometro":"538634,4 km","lugar":"Manuel Belgrano y Av. Juan Bautista Justo (Capital, Mendoza)","esImpacto":false},{"lat":-32.8841761,"lng":-68.8485365,"fecha":"2024-08-14T13:08:00.000Z","fechaEpoch":1723640880000,"velocidad":7,"odometro":"538634,4 km","lugar":"Manuel Belgrano y Av. Juan Bautista Justo (Capital, Mendoza)","esImpacto":false},{"lat":-32.8841948,"lng":-68.8485386,"fecha":"2024-08-14T13:08:00.000Z","fechaEpoch":1723640880000,"velocidad":6,"odometro":"538634,5 km","lugar":"Manuel Belgrano y Av. Juan Bautista Justo (Capital, Mendoza)","esImpacto":false},{"lat":-32.884209,"lng":-68.8485476,"fecha":"2024-08-14T13:08:00.000Z","fechaEpoch":1723640880000,"velocidad":0,"odometro":"538634,5 km","lugar":"Manuel Belgrano y Av. Juan Bautista Justo (Capital, Mendoza)","esImpacto":true},{"lat":-32.8843583,"lng":-68.848577,"fecha":"2024-08-14T13:09:00.000Z","fechaEpoch":1723640940000,"velocidad":20,"odometro":"538634,5 km","lugar":"Manuel Belgrano y Av. Juan Bautista Justo (Capital, Mendoza)","esImpacto":false},{"lat":-32.8846355,"lng":-68.8486328,"fecha":"2024-08-14T13:09:00.000Z","fechaEpoch":1723640940000,"velocidad":17,"odometro":"538634,5 km","lugar":"Manuel Belgrano y Av. Las Heras (Capital, Mendoza)","esImpacto":false},{"lat":-32.884671,"lng":-68.848657,"fecha":"2024-08-14T13:09:00.000Z","fechaEpoch":1723640940000,"velocidad":14,"odometro":"538634,5 km","lugar":"Manuel Belgrano y Av. Juan Bautista Justo (Capital, Mendoza)","esImpacto":false},{"lat":-32.8847275,"lng":-68.8486638,"fecha":"2024-08-14T13:09:00.000Z","fechaEpoch":1723640940000,"velocidad":20,"odometro":"538634,5 km","lugar":"Manuel Belgrano y Av. Las Heras (Capital, Mendoza)","esImpacto":false},{"lat":-32.8847526,"lng":-68.8486811,"fecha":"2024-08-14T13:09:00.000Z","fechaEpoch":1723640940000,"velocidad":16,"odometro":"538634,5 km","lugar":"Ciclovía y Av. Juan Bautista Justo (Capital, Mendoza)","esImpacto":false},{"lat":-32.8852886,"lng":-68.8488103,"fecha":"2024-08-14T13:10:00.000Z","fechaEpoch":1723641000000,"velocidad":0,"odometro":"538634,6 km","lugar":"Manuel Belgrano y Necochea (Capital, Mendoza)","esImpacto":true},{"lat":-32.8854246,"lng":-68.848862,"fecha":"2024-08-14T13:10:00.000Z","fechaEpoch":1723641000000,"velocidad":21,"odometro":"538634,6 km","lugar":"Julio Leónidas Aguirre y Manuel Belgrano (Capital, Mendoza)","esImpacto":false},{"lat":-32.8863576,"lng":-68.8490951,"fecha":"2024-08-14T13:10:00.000Z","fechaEpoch":1723641000000,"velocidad":0,"odometro":"538634,7 km","lugar":"Ciclovía y Nicolás Avellaneda (Capital, Mendoza)","esImpacto":true},{"lat":-32.8866331,"lng":-68.8491398,"fecha":"2024-08-14T13:11:00.000Z","fechaEpoch":1723641060000,"velocidad":26,"odometro":"538634,7 km","lugar":"Nicolás Avellaneda y Manuel Belgrano (Capital, Mendoza)","esImpacto":false},{"lat":-32.8874633,"lng":-68.8493473,"fecha":"2024-08-14T13:11:00.000Z","fechaEpoch":1723641060000,"velocidad":2,"odometro":"538634,8 km","lugar":"Manuel Belgrano y General Espejo (Capital, Mendoza)","esImpacto":false},{"lat":-32.8884901,"lng":-68.8496245,"fecha":"2024-08-14T13:11:00.000Z","fechaEpoch":1723641060000,"velocidad":36,"odometro":"538635,0 km","lugar":"Manuel Belgrano y Sarmiento (Capital, Mendoza)","esImpacto":false},{"lat":-32.888505,"lng":-68.8496896,"fecha":"2024-08-14T13:11:00.000Z","fechaEpoch":1723641060000,"velocidad":26,"odometro":"538635,0 km","lugar":"Ciclovía y Sarmiento (Capital, Mendoza)","esImpacto":false},{"lat":-32.8886043,"lng":-68.8497378,"fecha":"2024-08-14T13:11:00.000Z","fechaEpoch":1723641060000,"velocidad":35,"odometro":"538635,0 km","lugar":"Ciclovía y Sarmiento (Capital, Mendoza)","esImpacto":false},{"lat":-32.8887093,"lng":-68.849723,"fecha":"2024-08-14T13:11:00.000Z","fechaEpoch":1723641060000,"velocidad":33,"odometro":"538635,0 km","lugar":"Ciclovía y Sarmiento (Capital, Mendoza)","esImpacto":false},{"lat":-32.8903578,"lng":-68.8500793,"fecha":"2024-08-14T13:12:00.000Z","fechaEpoch":1723641120000,"velocidad":0,"odometro":"538635,2 km","lugar":"Manuel Belgrano y Reconquista (Capital, Mendoza)","esImpacto":true},{"lat":-32.8904606,"lng":-68.8501356,"fecha":"2024-08-14T13:13:00.000Z","fechaEpoch":1723641180000,"velocidad":5,"odometro":"538635,2 km","lugar":"Manuel Belgrano y Reconquista (Capital, Mendoza)","esImpacto":false},{"lat":-32.8911811,"lng":-68.8503486,"fecha":"2024-08-14T13:13:00.000Z","fechaEpoch":1723641180000,"velocidad":19,"odometro":"538635,3 km","lugar":"Montevideo y Manuel Belgrano (Capital, Mendoza)","esImpacto":false},{"lat":-32.8916771,"lng":-68.8504843,"fecha":"2024-08-14T13:13:00.000Z","fechaEpoch":1723641180000,"velocidad":0,"odometro":"538635,3 km","lugar":"San Lorenzo y Manuel Belgrano (Capital, Mendoza)","esImpacto":true},{"lat":-32.8919175,"lng":-68.8505243,"fecha":"2024-08-14T13:14:00.000Z","fechaEpoch":1723641240000,"velocidad":20,"odometro":"538635,4 km","lugar":"San Lorenzo y Manuel Belgrano (Capital, Mendoza)","esImpacto":false},{"lat":-32.8931281,"lng":-68.8508788,"fecha":"2024-08-14T13:14:00.000Z","fechaEpoch":1723641240000,"velocidad":25,"odometro":"538635,5 km","lugar":"Manuel Belgrano y Av. Colón (Capital, Mendoza)","esImpacto":false},{"lat":-32.8954096,"lng":-68.8514826,"fecha":"2024-08-14T13:15:00.000Z","fechaEpoch":1723641300000,"velocidad":27,"odometro":"538635,8 km","lugar":"Pasaje General Belgrano y Manuel Belgrano (Capital, Mendoza)","esImpacto":false},{"lat":-32.8960858,"lng":-68.8516711,"fecha":"2024-08-14T13:15:00.000Z","fechaEpoch":1723641300000,"velocidad":31,"odometro":"538635,9 km","lugar":"Pasaje General Belgrano y Manuel Belgrano (Capital, Mendoza)","esImpacto":false},{"lat":-32.8961155,"lng":-68.8516451,"fecha":"2024-08-14T13:15:00.000Z","fechaEpoch":1723641300000,"velocidad":17,"odometro":"538635,9 km","lugar":"Pasaje General Belgrano y Manuel Belgrano (Capital, Mendoza)","esImpacto":false},{"lat":-32.896186,"lng":-68.8516673,"fecha":"2024-08-14T13:15:00.000Z","fechaEpoch":1723641300000,"velocidad":29,"odometro":"538635,9 km","lugar":"Pasaje General Belgrano y Manuel Belgrano (Capital, Mendoza)","esImpacto":false},{"lat":-32.8967203,"lng":-68.8518355,"fecha":"2024-08-14T13:15:00.000Z","fechaEpoch":1723641300000,"velocidad":19,"odometro":"538635,9 km","lugar":"Pasaje Kelesis y Manuel Belgrano (Capital, Mendoza)","esImpacto":false},{"lat":-32.896765,"lng":-68.851838,"fecha":"2024-08-14T13:15:00.000Z","fechaEpoch":1723641300000,"velocidad":14,"odometro":"538635,9 km","lugar":"Pasaje Kelesis y Manuel Belgrano (Capital, Mendoza)","esImpacto":false},{"lat":-32.8967991,"lng":-68.851839,"fecha":"2024-08-14T13:15:00.000Z","fechaEpoch":1723641300000,"velocidad":14,"odometro":"538635,9 km","lugar":"Pasaje Kelesis y Manuel Belgrano (Capital, Mendoza)","esImpacto":false},{"lat":-32.8969491,"lng":-68.8518685,"fecha":"2024-08-14T13:15:00.000Z","fechaEpoch":1723641300000,"velocidad":0,"odometro":"538636,0 km","lugar":"Pasaje Kelesis y Manuel Belgrano (Capital, Mendoza)","esImpacto":true},{"lat":-32.897078,"lng":-68.8519146,"fecha":"2024-08-14T13:16:00.000Z","fechaEpoch":1723641360000,"velocidad":22,"odometro":"538636,0 km","lugar":"Pasaje Kelesis y Manuel Belgrano (Capital, Mendoza)","esImpacto":false},{"lat":-32.899955,"lng":-68.852663,"fecha":"2024-08-14T13:16:00.000Z","fechaEpoch":1723641360000,"velocidad":44,"odometro":"538636,3 km","lugar":"Av. Peltier y Martín Palero (Capital, Mendoza)","esImpacto":false},{"lat":-32.901957,"lng":-68.8530293,"fecha":"2024-08-14T13:16:00.000Z","fechaEpoch":1723641360000,"velocidad":21,"odometro":"538636,5 km","lugar":"Olegario Víctor Andrade y Martín Palero (Capital, Mendoza)","esImpacto":false},{"lat":-32.9020033,"lng":-68.8530261,"fecha":"2024-08-14T13:16:00.000Z","fechaEpoch":1723641360000,"velocidad":18,"odometro":"538636,5 km","lugar":"Olegario Víctor Andrade y Martín Palero (Capital, Mendoza)","esImpacto":false},{"lat":-32.9042116,"lng":-68.8529713,"fecha":"2024-08-14T13:17:00.000Z","fechaEpoch":1723641420000,"velocidad":24,"odometro":"538636,8 km","lugar":"25 de Mayo y Pascual Segura (Godoy Cruz, Mendoza)","esImpacto":false},{"lat":-32.9045501,"lng":-68.852956,"fecha":"2024-08-14T13:17:00.000Z","fechaEpoch":1723641420000,"velocidad":0,"odometro":"538636,8 km","lugar":"25 de Mayo y Pascual Segura (Godoy Cruz, Mendoza)","esImpacto":true},{"lat":-32.9047301,"lng":-68.8529575,"fecha":"2024-08-14T13:18:00.000Z","fechaEpoch":1723641480000,"velocidad":24,"odometro":"538636,8 km","lugar":"25 de Mayo y Pascual Segura (Godoy Cruz, Mendoza)","esImpacto":false},{"lat":-32.9061316,"lng":-68.8527355,"fecha":"2024-08-14T13:18:00.000Z","fechaEpoch":1723641480000,"velocidad":46,"odometro":"538637,0 km","lugar":"Pascual Segura y Amengual (Godoy Cruz, Mendoza)","esImpacto":false},{"lat":-32.9062531,"lng":-68.8527091,"fecha":"2024-08-14T13:18:00.000Z","fechaEpoch":1723641480000,"velocidad":49,"odometro":"538637,0 km","lugar":"Pascual Segura y Amengual (Godoy Cruz, Mendoza)","esImpacto":false},{"lat":-32.9085793,"lng":-68.8520248,"fecha":"2024-08-14T13:18:00.000Z","fechaEpoch":1723641480000,"velocidad":10,"odometro":"538637,3 km","lugar":"Pascual Segura y Arizu (Godoy Cruz, Mendoza)","esImpacto":false},{"lat":-32.9086066,"lng":-68.8520236,"fecha":"2024-08-14T13:18:00.000Z","fechaEpoch":1723641480000,"velocidad":0,"odometro":"538637,3 km","lugar":"Pascual Segura y Arizu (Godoy Cruz, Mendoza)","esImpacto":true},{"lat":-32.9087476,"lng":-68.851992,"fecha":"2024-08-14T13:19:00.000Z","fechaEpoch":1723641540000,"velocidad":21,"odometro":"538637,3 km","lugar":"Pascual Segura y Sarratea (Godoy Cruz, Mendoza)","esImpacto":false},{"lat":-32.9097106,"lng":-68.8515126,"fecha":"2024-08-14T13:19:00.000Z","fechaEpoch":1723641540000,"velocidad":36,"odometro":"538637,4 km","lugar":"Pascual Segura y Gutiérrez (Godoy Cruz, Mendoza)","esImpacto":false},{"lat":-32.909797,"lng":-68.8514471,"fecha":"2024-08-14T13:19:00.000Z","fechaEpoch":1723641540000,"velocidad":41,"odometro":"538637,4 km","lugar":"Pascual Segura y Gutiérrez (Godoy Cruz, Mendoza)","esImpacto":false},{"lat":-32.9098981,"lng":-68.8513778,"fecha":"2024-08-14T13:19:00.000Z","fechaEpoch":1723641540000,"velocidad":43,"odometro":"538637,4 km","lugar":"Pascual Segura y Gutiérrez (Godoy Cruz, Mendoza)","esImpacto":false},{"lat":-32.909998,"lng":-68.851352,"fecha":"2024-08-14T13:19:00.000Z","fechaEpoch":1723641540000,"velocidad":42,"odometro":"538637,5 km","lugar":"Pascual Segura y Gutiérrez (Godoy Cruz, Mendoza)","esImpacto":false},{"lat":-32.9110878,"lng":-68.8507935,"fecha":"2024-08-14T13:19:00.000Z","fechaEpoch":1723641540000,"velocidad":40,"odometro":"538637,6 km","lugar":"Maipú y Coronel Beltrán (Godoy Cruz, Mendoza)","esImpacto":false},{"lat":-32.9111785,"lng":-68.8507368,"fecha":"2024-08-14T13:19:00.000Z","fechaEpoch":1723641540000,"velocidad":42,"odometro":"538637,6 km","lugar":"Maipú y Coronel Beltrán (Godoy Cruz, Mendoza)","esImpacto":false},{"lat":-32.9126733,"lng":-68.8497033,"fecha":"2024-08-14T13:19:00.000Z","fechaEpoch":1723641540000,"velocidad":61,"odometro":"538637,8 km","lugar":"L. Pasteur y Echeverría (Godoy Cruz, Mendoza)","esImpacto":false},{"lat":-32.9140941,"lng":-68.8485125,"fecha":"2024-08-14T13:20:00.000Z","fechaEpoch":1723641600000,"velocidad":49,"odometro":"538638,0 km","lugar":"Tropero Sosa y Almirante Brown (Godoy Cruz, Mendoza)","esImpacto":false},{"lat":-32.9156993,"lng":-68.8468918,"fecha":"2024-08-14T13:20:00.000Z","fechaEpoch":1723641600000,"velocidad":34,"odometro":"538638,2 km","lugar":"Pedro I. Anzorena y Roque Sáenz Peña (Godoy Cruz, Mendoza)","esImpacto":false},{"lat":-32.9157543,"lng":-68.8468185,"fecha":"2024-08-14T13:20:00.000Z","fechaEpoch":1723641600000,"velocidad":27,"odometro":"538638,2 km","lugar":"Pedro I. Anzorena y Roque Sáenz Peña (Godoy Cruz, Mendoza)","esImpacto":false},{"lat":-32.9160221,"lng":-68.8464985,"fecha":"2024-08-14T13:20:00.000Z","fechaEpoch":1723641600000,"velocidad":0,"odometro":"538638,3 km","lugar":"Dr. Adolfo Calle y Av. General San Martín Sur (Godoy Cruz, Mendoza)","esImpacto":true},{"lat":-32.9161426,"lng":-68.8463441,"fecha":"2024-08-14T13:21:00.000Z","fechaEpoch":1723641660000,"velocidad":21,"odometro":"538638,3 km","lugar":"Dr. Adolfo Calle y Av. General San Martín Sur (Godoy Cruz, Mendoza)","esImpacto":false},{"lat":-32.9184036,"lng":-68.843556,"fecha":"2024-08-14T13:21:00.000Z","fechaEpoch":1723641660000,"velocidad":61,"odometro":"538638,7 km","lugar":"Avellaneda y General Manuel Belgrano (Godoy Cruz, Mendoza)","esImpacto":false},{"lat":-32.9203881,"lng":-68.8411381,"fecha":"2024-08-14T13:21:00.000Z","fechaEpoch":1723641660000,"velocidad":48,"odometro":"538639,0 km","lugar":"General M. Balcarce y Jose Lencinas (Godoy Cruz, Mendoza)","esImpacto":false},{"lat":-32.9214968,"lng":-68.8397775,"fecha":"2024-08-14T13:22:00.000Z","fechaEpoch":1723641720000,"velocidad":0,"odometro":"538639,2 km","lugar":"Mitre y Jose Lencinas (Godoy Cruz, Mendoza)","esImpacto":true},{"lat":-32.9216255,"lng":-68.8396665,"fecha":"2024-08-14T13:22:00.000Z","fechaEpoch":1723641720000,"velocidad":22,"odometro":"538639,2 km","lugar":"Mitre y Jose Lencinas (Godoy Cruz, Mendoza)","esImpacto":false},{"lat":-32.921733,"lng":-68.839498,"fecha":"2024-08-14T13:22:00.000Z","fechaEpoch":1723641720000,"velocidad":24,"odometro":"538639,2 km","lugar":"Mitre y Jose Lencinas (Godoy Cruz, Mendoza)","esImpacto":false},{"lat":-32.9217715,"lng":-68.8394298,"fecha":"2024-08-14T13:22:00.000Z","fechaEpoch":1723641720000,"velocidad":23,"odometro":"538639,2 km","lugar":"Mitre y Jose Lencinas (Godoy Cruz, Mendoza)","esImpacto":false},{"lat":-32.9218303,"lng":-68.8393546,"fecha":"2024-08-14T13:22:00.000Z","fechaEpoch":1723641720000,"velocidad":31,"odometro":"538639,2 km","lugar":"Mitre y Jose Lencinas (Godoy Cruz, Mendoza)","esImpacto":false},{"lat":-32.9240551,"lng":-68.8366783,"fecha":"2024-08-14T13:23:00.000Z","fechaEpoch":1723641780000,"velocidad":35,"odometro":"538639,6 km","lugar":"Remedios de Escalada de San Martín y Palmira (Guaymallén, Mendoza)","esImpacto":false},{"lat":-32.9261648,"lng":-68.8340718,"fecha":"2024-08-14T13:23:00.000Z","fechaEpoch":1723641780000,"velocidad":38,"odometro":"538639,9 km","lugar":"Progreso y Valle Grande (Godoy Cruz, Mendoza)","esImpacto":false},{"lat":-32.9268738,"lng":-68.8332246,"fecha":"2024-08-14T13:23:00.000Z","fechaEpoch":1723641780000,"velocidad":13,"odometro":"538640,0 km","lugar":"Progreso y Valle Grande (Godoy Cruz, Mendoza)","esImpacto":false},{"lat":-32.92689,"lng":-68.8332001,"fecha":"2024-08-14T13:23:00.000Z","fechaEpoch":1723641780000,"velocidad":8,"odometro":"538640,0 km","lugar":"Progreso y Valle Grande (Godoy Cruz, Mendoza)","esImpacto":false},{"lat":-32.9269071,"lng":-68.8331825,"fecha":"2024-08-14T13:23:00.000Z","fechaEpoch":1723641780000,"velocidad":9,"odometro":"538640,0 km","lugar":"Progreso y Valle Grande (Godoy Cruz, Mendoza)","esImpacto":false},{"lat":-32.9269201,"lng":-68.8331665,"fecha":"2024-08-14T13:24:00.000Z","fechaEpoch":1723641840000,"velocidad":0,"odometro":"538640,0 km","lugar":"Progreso y Valle Grande (Godoy Cruz, Mendoza)","esImpacto":true},{"lat":-32.9270415,"lng":-68.8330053,"fecha":"2024-08-14T13:24:00.000Z","fechaEpoch":1723641840000,"velocidad":22,"odometro":"538640,1 km","lugar":"Valle Grande y J. M. Ampere (Godoy Cruz, Mendoza)","esImpacto":false},{"lat":-32.9294516,"lng":-68.8301221,"fecha":"2024-08-14T13:24:00.000Z","fechaEpoch":1723641840000,"velocidad":41,"odometro":"538640,4 km","lugar":"Valle Grande y Los Reyunos (Godoy Cruz, Mendoza)","esImpacto":false},{"lat":-32.9314405,"lng":-68.8276881,"fecha":"2024-08-14T13:25:00.000Z","fechaEpoch":1723641900000,"velocidad":32,"odometro":"538640,8 km","lugar":"Acceso Sur y Ruta Nacional 40 (Godoy Cruz, Mendoza)","esImpacto":false},{"lat":-32.9329258,"lng":-68.8258923,"fecha":"2024-08-14T13:25:00.000Z","fechaEpoch":1723641900000,"velocidad":2,"odometro":"538641,0 km","lugar":"Alsina e Independencia (Godoy Cruz, Mendoza)","esImpacto":false},{"lat":-32.9329366,"lng":-68.8258791,"fecha":"2024-08-14T13:25:00.000Z","fechaEpoch":1723641900000,"velocidad":0,"odometro":"538641,0 km","lugar":"Alsina e Independencia (Godoy Cruz, Mendoza)","esImpacto":true},{"lat":-32.9330738,"lng":-68.8257213,"fecha":"2024-08-14T13:26:00.000Z","fechaEpoch":1723641960000,"velocidad":23,"odometro":"538641,0 km","lugar":"Alsina e Independencia (Godoy Cruz, Mendoza)","esImpacto":false},{"lat":-32.9356403,"lng":-68.8225945,"fecha":"2024-08-14T13:26:00.000Z","fechaEpoch":1723641960000,"velocidad":56,"odometro":"538641,4 km","lugar":"Alsina (Godoy Cruz, Mendoza)","esImpacto":false},{"lat":-32.9381561,"lng":-68.8194961,"fecha":"2024-08-14T13:27:00.000Z","fechaEpoch":1723642020000,"velocidad":24,"odometro":"538641,8 km","lugar":"Julio Preciado y Valle Grande (Godoy Cruz, Mendoza)","esImpacto":false},{"lat":-32.9382875,"lng":-68.8193363,"fecha":"2024-08-14T13:27:00.000Z","fechaEpoch":1723642020000,"velocidad":0,"odometro":"538641,9 km","lugar":"Julio Preciado y Valle Grande (Godoy Cruz, Mendoza)","esImpacto":true},{"lat":-32.9384163,"lng":-68.819206,"fecha":"2024-08-14T13:27:00.000Z","fechaEpoch":1723642020000,"velocidad":22,"odometro":"538641,9 km","lugar":"Julio Preciado y Valle Grande (Godoy Cruz, Mendoza)","esImpacto":false},{"lat":-32.9407398,"lng":-68.8163153,"fecha":"2024-08-14T13:28:00.000Z","fechaEpoch":1723642080000,"velocidad":45,"odometro":"538642,3 km","lugar":"Agusto T. Vandor y Valle Grande (Godoy Cruz, Mendoza)","esImpacto":false},{"lat":-32.9416845,"lng":-68.8151776,"fecha":"2024-08-14T13:28:00.000Z","fechaEpoch":1723642080000,"velocidad":0,"odometro":"538642,4 km","lugar":"Valle Grande y 9 de Julio (Mendoza, Argentina)","esImpacto":true},{"lat":-32.9418025,"lng":-68.8150635,"fecha":"2024-08-14T13:28:00.000Z","fechaEpoch":1723642080000,"velocidad":20,"odometro":"538642,4 km","lugar":"Valle Grande y 9 de Julio (Mendoza, Argentina)","esImpacto":false},{"lat":-32.9441651,"lng":-68.812207,"fecha":"2024-08-14T13:29:00.000Z","fechaEpoch":1723642140000,"velocidad":46,"odometro":"538642,8 km","lugar":"Los Ceibos y Río de Uspallata (Maipú, Mendoza)","esImpacto":false},{"lat":-32.9464285,"lng":-68.8094505,"fecha":"2024-08-14T13:29:00.000Z","fechaEpoch":1723642140000,"velocidad":48,"odometro":"538643,2 km","lugar":"Virgen de Las Nieves y Virgen de Loreto (Maipú, Mendoza)","esImpacto":false},{"lat":-32.9474565,"lng":-68.8081838,"fecha":"2024-08-14T13:30:00.000Z","fechaEpoch":1723642200000,"velocidad":0,"odometro":"538643,3 km","lugar":"Villanueva e Hipólito Yrigoyen (Maipú, Mendoza)","esImpacto":true},{"lat":-32.9475395,"lng":-68.8080521,"fecha":"2024-08-14T13:30:00.000Z","fechaEpoch":1723642200000,"velocidad":21,"odometro":"538643,3 km","lugar":"Villanueva e Hipólito Yrigoyen (Maipú, Mendoza)","esImpacto":false},{"lat":-32.9495058,"lng":-68.8056403,"fecha":"2024-08-14T13:31:00.000Z","fechaEpoch":1723642260000,"velocidad":41,"odometro":"538643,7 km","lugar":"Olivera y Tierra del Fuego (Maipú, Mendoza)","esImpacto":false},{"lat":-32.9513708,"lng":-68.8032193,"fecha":"2024-08-14T13:31:00.000Z","fechaEpoch":1723642260000,"velocidad":43,"odometro":"538644,0 km","lugar":"Sobral y Olivera (Maipú, Mendoza)","esImpacto":false},{"lat":-32.9524523,"lng":-68.8012943,"fecha":"2024-08-14T13:31:00.000Z","fechaEpoch":1723642260000,"velocidad":22,"odometro":"538644,2 km","lugar":"Olivera y Piedra Buena (Maipú, Mendoza)","esImpacto":false},{"lat":-32.9524721,"lng":-68.8012463,"fecha":"2024-08-14T13:31:00.000Z","fechaEpoch":1723642260000,"velocidad":17,"odometro":"538644,2 km","lugar":"Olivera y Piedra Buena (Maipú, Mendoza)","esImpacto":false},{"lat":-32.9525143,"lng":-68.8011708,"fecha":"2024-08-14T13:32:00.000Z","fechaEpoch":1723642320000,"velocidad":0,"odometro":"538644,2 km","lugar":"Olivera y Piedra Buena (Maipú, Mendoza)","esImpacto":true},{"lat":-32.9525831,"lng":-68.8010208,"fecha":"2024-08-14T13:32:00.000Z","fechaEpoch":1723642320000,"velocidad":21,"odometro":"538644,2 km","lugar":"Olivera y Piedra Buena (Maipú, Mendoza)","esImpacto":false},{"lat":-32.9526111,"lng":-68.8009575,"fecha":"2024-08-14T13:32:00.000Z","fechaEpoch":1723642320000,"velocidad":22,"odometro":"538644,2 km","lugar":"Olivera y Piedra Buena (Maipú, Mendoza)","esImpacto":false},{"lat":-32.952655,"lng":-68.8008966,"fecha":"2024-08-14T13:32:00.000Z","fechaEpoch":1723642320000,"velocidad":28,"odometro":"538644,2 km","lugar":"Olivera y Piedra Buena (Maipú, Mendoza)","esImpacto":false},{"lat":-32.9532318,"lng":-68.7996865,"fecha":"2024-08-14T13:32:00.000Z","fechaEpoch":1723642320000,"velocidad":43,"odometro":"538644,4 km","lugar":"Olivera y Moyano (Maipú, Mendoza)","esImpacto":false},{"lat":-32.9532858,"lng":-68.7995756,"fecha":"2024-08-14T13:32:00.000Z","fechaEpoch":1723642320000,"velocidad":43,"odometro":"538644,4 km","lugar":"Olivera y Moyano (Maipú, Mendoza)","esImpacto":false},{"lat":-32.9546451,"lng":-68.7960958,"fecha":"2024-08-14T13:33:00.000Z","fechaEpoch":1723642380000,"velocidad":33,"odometro":"538644,7 km","lugar":"Hipólito Yrigoyen (Maipú, Mendoza)","esImpacto":false},{"lat":-32.9547376,"lng":-68.795818,"fecha":"2024-08-14T13:33:00.000Z","fechaEpoch":1723642380000,"velocidad":0,"odometro":"538644,8 km","lugar":"Hipólito Yrigoyen (Maipú, Mendoza)","esImpacto":true}]</script>
  <script id="IMPACTO_JSON" type="application/json">{"lat":-32.8663826,"lng":-68.8438161}</script>
</head>
<body>
  <div id="map"></div>

  <div class="ui">
    <h3>Reconstrucción geográfica y cinemática</h3>
    <div class="row"><div>Posición en la trayectoria</div><div id="idxLabel" class="kpi">-</div></div>
    <input id="slider" type="range" min="0" max="0" step="1" value="0"/>
    <div class="controls">
      <button id="playBtn">▶︎ Reproducir</button>
      <button id="pauseBtn">⏸ Pausa</button>
      <button id="resetBtn">⟲ Reset</button>
      <select id="speedSel"><option>1×</option><option>2×</option><option>4×</option><option>8×</option></select>
      <button id="baseToggleBtn">🗺️ Mapa: Google/Esri</button>
    </div>
    <div class="controls">
      <button id="measureBtn">📏 Medir</button>
      <button id="measureClearBtn">🗑️ Limpiar</button>
      <button id="crop800Btn">🔪 Ver últimos 800 m</button>
    </div>
    <div class="legend">
      <span><i class="dot" style="background:#F00"></i>Impacto / v=0</span>
      <span><i class="dot" style="background:#F90"></i>&lt; 5 km/h</span>
      <span><i class="dot" style="background:#0F0"></i>&lt; 30 km/h</span>
      <span><i class="dot" style="background:#00F"></i>≥ 30 km/h</span>
    </div>
    <div class="grid">
      <div class="card">
        <div><strong>Total recorrido</strong></div><div id="totalDist">-</div>
        <div><strong>Tiempo total</strong></div><div id="totalTime">-</div>
        <div><strong>Vel. media</strong></div><div id="avgSpeed">-</div>
      </div>
      <div class="card">
        <div><strong>Punto actual</strong></div>
        <div>Fecha/Hora: <span id="curTime">-</span></div>
        <div>Ubicación/Coords: <span id="curPlace">-</span></div>
        <div>Vel.: <span id="curSpeed">-</span></div>
      </div>
    </div>
    <div class="card" style="margin-top:10px;">
      <div><strong>Tramo actual (i → i+1)</strong></div>
      <div>Δd: <span id="segDist">-</span></div>
      <div>Δt: <span id="segTime">-</span></div>
      <div>v promedio tramo: <span id="segV">-</span></div>
    </div>
    <div class="badge">
      Lic. Sebastián C. González — NEXO Forense<br/>Licenciado en Criminalística | Consultor en Seguridad Pública y Privada
    </div>
  </div>

  <div id="labelsLayer" class="float-note"></div>

  <script defer>
    
    const trayectoria = JSON.parse(document.getElementById('TRAY_JSON').textContent);
    const puntoImpacto = JSON.parse(document.getElementById('IMPACTO_JSON').textContent);

    
    const TZ='America/Argentina/Mendoza';
    const fmtLocal=d=>new Intl.DateTimeFormat('es-AR',{dateStyle:'medium',timeStyle:'medium',timeZone:TZ}).format(d);
    function parseFecha(s){if(s==null)return null; if(Object.prototype.toString.call(s)==='[object Date]')return s;
      if(typeof s==='string'){const t=s.trim(); if(t.includes('T')){const d=new Date(t);return isNaN(d)?null:d;}
        const parts=t.split(' '); if(parts.length>=2){const[dmy,hm]=parts; const[d,m,yr]=dmy.split(/[\/\-\.]/).map(n=>parseInt(n,10));
          const[H,M]=hm.split(':').map(n=>parseInt(n,10)); if([d,m,yr,H,M].every(n=>!isNaN(n))){const y=(yr<100)?2000+yr:yr; const dd=new Date(y,m-1,d,H,M,0,0); return isNaN(dd)?null:dd;}}
        const d2=new Date(t); return isNaN(d2)?null:d2;}
      if(typeof s==='number'){const d=new Date(s);return isNaN(d)?null:d;} return null;}
    function haversine(a,b,c,d){const R=6371000,t=x=>x*Math.PI/180;const dLat=t(c-a),dLon=t(d-b);
      const A=Math.sin(dLat/2)**2+Math.cos(t(a))*Math.cos(t(c))*Math.sin(dLon/2)**2;return 2*R*Math.atan2(Math.sqrt(A),Math.sqrt(1-A))}
    const fmtM=m=>m<1000?`${m.toFixed(1)} m`:`${(m/1000).toFixed(3)} km`;
    function fmtS(s){if(!isFinite(s))return'-';s=Math.round(s);const h=Math.floor(s/3600),m=Math.floor((s%3600)/60),r=s%60;return(h?`${h}h `:'')+(m?`${m}m `:'')+`${r}s`;}
    const speedColor=(v,z)=>z?'#F00':(v<5?'#F90':(v<30?'#0F0':'#00F'));
    function showNote(h,ms=3000){const el=document.getElementById('labelsLayer');el.innerHTML=h;el.style.display='block';clearTimeout(showNote._t);showNote._t=setTimeout(()=>{el.style.display='none'},ms);}

    
    const P=(Array.isArray(trayectoria)?trayectoria:[]).filter(p=>Number.isFinite(p.lat)&&Number.isFinite(p.lng))
      .map(p=>({...p,fechaDate:(p.fechaEpoch?new Date(p.fechaEpoch):parseFecha(p.fecha))}))
      .sort((a,b)=>(a.fechaDate&&b.fechaDate)?(a.fechaDate-b.fechaDate):0);

    const segDist=[],segTime=[],cumDist=[0],cumTime=[0];
    for(let i=0;i<P.length-1;i++){const d=haversine(P[i].lat,P[i].lng,P[i+1].lat,P[i+1].lng);
      const t=(P[i].fechaDate&&P[i+1].fechaDate)?(P[i+1].fechaDate-P[i].fechaDate)/1000:NaN;
      segDist[i]=d;segTime[i]=t;cumDist[i+1]=cumDist[i]+d;cumTime[i+1]=Number.isFinite(t)?(cumTime[i]+t):cumTime[i];}
    const totalDistM=cumDist[cumDist.length-1]||0,totalTimeS=cumTime[cumTime.length-1]||0,avgSpeed=totalTimeS>0?(totalDistM/totalTimeS)*3.6:NaN;

    
    let map,polyline,movingMarker,infoWindow,animTimer=null,animSpeed=1,curIndex=0,currentBase='google';

    function initMapReal(){
      map=new google.maps.Map(document.getElementById('map'),{zoom:17,center:{lat:puntoImpacto.lat,lng:puntoImpacto.lng},mapTypeId:'satellite',gestureHandling:'greedy'});
      const esri=new google.maps.ImageMapType({
  getTileUrl:(c,z)=>{
    return 'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/'
      + z + '/' + c.y + '/' + c.x;
  },
  tileSize:new google.maps.Size(256,256),
  name:'EsriWorldImagery',
  maxZoom:19
});
      map.mapTypes.set('esri',esri);

      const path=P.map(p=>({lat:p.lat,lng:p.lng}));
      if(path.length){polyline=new google.maps.Polyline({path,geodesic:true,strokeColor:'#0070FF',strokeOpacity:.8,strokeWeight:5,map});}

      infoWindow=new google.maps.InfoWindow();
      P.forEach((p,idx)=>{const color=speedColor(p.velocidad,p.esImpacto);
        const m=new google.maps.Marker({position:{lat:p.lat,lng:p.lng},map,icon:{path:google.maps.SymbolPath.CIRCLE,fillColor:color,fillOpacity:.9,scale:p.esImpacto?12:6,strokeWeight:0},title:`Velocidad: ${p.velocidad} km/h`});
        m.addListener('click',()=>{infoWindow.setContent(`<strong>Punto #${idx+1}</strong><br><strong>Fecha/Hora:</strong> ${p.fechaDate?fmtLocal(p.fechaDate):(p.fecha??'-')}<br><strong>Ubicación/Coords:</strong> ${(p.lugar?p.lugar+' — ':'')}${p.lat.toFixed(6)}, ${p.lng.toFixed(6)}<br><strong>Velocidad:</strong> <span style="color:${color};font-weight:700;">${p.velocidad??'-'} km/h</span><br><strong>Odómetro:</strong> ${p.odometro??'-'}<br>`);infoWindow.open(map,m);});});

      const tramIcon={url:'data:image/svg+xml;utf8,'+encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 32 32"><g fill="#1f1f1f"><rect x="6" y="8" width="20" height="12" rx="2" ry="2"/><rect x="9" y="11" width="5" height="5" fill="#4a90e2"/><rect x="18" y="11" width="5" height="5" fill="#4a90e2"/><rect x="12" y="5" width="8" height="2" /><circle cx="12" cy="21" r="2"/><circle cx="20" cy="21" r="2"/></g></svg>`),scaledSize:new google.maps.Size(28,28),anchor:new google.maps.Point(14,14)};
      if(path.length){movingMarker=new google.maps.Marker({position:path[0],map,icon:tramIcon});}

      setupUI();updateUI(0);attachMeasureHandlers();
    }
    window.__initMapReal=initMapReal;if(window.__initMapPending){try{window.__initMapReal()}finally{window.__initMapPending=false}}

    function setupUI(){const s=document.getElementById('slider'),pb=document.getElementById('playBtn'),ps=document.getElementById('pauseBtn'),rb=document.getElementById('resetBtn'),sp=document.getElementById('speedSel'),tb=document.getElementById('baseToggleBtn');
      s.max=Math.max(0,P.length-1);s.value=0;pb.onclick=()=>startAnimation();ps.onclick=()=>stopAnimation();rb.onclick=()=>{stopAnimation();goToIndex(0)};sp.onchange=e=>{animSpeed=Number(e.target.value)||1};s.oninput=e=>{stopAnimation();goToIndex(Number(e.target.value))};tb.onclick=()=>toggleBase();
      document.getElementById('totalDist').textContent=fmtM(totalDistM);document.getElementById('totalTime').textContent=fmtS(totalTimeS);document.getElementById('avgSpeed').textContent=isFinite(avgSpeed)?`${avgSpeed.toFixed(1)} km/h`:'-';}
    function toggleBase(){if(!map)return; if(currentBase==='google'){map.setMapTypeId('esri');currentBase='esri';showNote('Base: Esri World Imagery')}else{map.setMapTypeId('satellite');currentBase='google';showNote('Base: Google Satélite')}}
    function goToIndex(i){if(!P.length||!movingMarker)return;curIndex=Math.max(0,Math.min(P.length-1,i));movingMarker.setPosition({lat:P[curIndex].lat,lng:P[curIndex].lng});updateUI(curIndex)}
    function updateUI(i){document.getElementById('idxLabel').textContent=`${P.length?(i+1):0} / ${P.length}`;document.getElementById('slider').value=Math.min(i,Math.max(0,P.length-1));
      const p=P[i];if(!p){document.getElementById('curTime').textContent='-';return}const c=speedColor(p.velocidad,p.esImpacto);
      document.getElementById('curTime').textContent=p.fechaDate?fmtLocal(p.fechaDate):(p.fecha??'-');
      document.getElementById('curPlace').textContent=(p.lugar?`${p.lugar} — `:'')+`${p.lat.toFixed(6)}, ${p.lng.toFixed(6)}`;
      document.getElementById('curSpeed').innerHTML=`<span style="color:${c};font-weight:700;">${p.velocidad??'-'} km/h</span>`;
      if(i<P.length-1){const d=segDist[i],t=segTime[i],v=(isFinite(d)&&isFinite(t)&&t>0)?(d/t)*3.6:NaN;
        document.getElementById('segDist').textContent=isFinite(d)?fmtM(d):'-';
        document.getElementById('segTime').textContent=isFinite(t)?fmtS(t):'-';
        document.getElementById('segV').textContent=isFinite(v)?`${v.toFixed(1)} km/h`:'-';
      }else{document.getElementById('segDist').textContent='-';document.getElementById('segTime').textContent='-';document.getElementById('segV').textContent='-';}}
    function startAnimation(){if(animTimer||P.length<2||!movingMarker)return;const step=()=>{if(curIndex>=P.length-1){stopAnimation();return}
        const i=curIndex,t=segTime[i],has=Number.isFinite(t)&&t>0,dt=has?(t*1000)/animSpeed:(400/animSpeed);const steps=20;let k=0;const a=P[i],b=P[i+1];
        const interp=()=>{k++;const x=Math.min(1,k/steps);movingMarker.setPosition({lat:a.lat+(b.lat-a.lat)*x,lng:a.lng+(b.lng-a.lng)*x});
          if(k<steps)animTimer=setTimeout(interp,dt/steps);else{curIndex=i+1;updateUI(curIndex);animTimer=setTimeout(step,0)}};interp()};step()}
    function stopAnimation(){if(animTimer){clearTimeout(animTimer);animTimer=null}}

    
    let measureMode=false,measureLine=null,measureMarkers=[];
    function toggleMeasure(){measureMode=!measureMode;showNote(measureMode?'Modo medición: haga dos clics en el mapa.':'Medición desactivada.',2500);if(!measureMode)clearMeasure()}
    function clearMeasure(){if(measureLine){measureLine.setMap(null);measureLine=null}measureMarkers.forEach(m=>m.setMap(null));measureMarkers=[]}
    function attachMeasureHandlers(){let clicks=[];document.getElementById('measureBtn').onclick=()=>toggleMeasure();document.getElementById('measureClearBtn').onclick=()=>clearMeasure();document.getElementById('crop800Btn').onclick=()=>cropToLastMeters(800);
      if(!map)return;map.addListener('click',e=>{if(!measureMode)return;clicks.push(e.latLng);const m=new google.maps.Marker({position:e.latLng,map,icon:{path:google.maps.SymbolPath.CIRCLE,scale:5,fillColor:'#000',fillOpacity:1,strokeWeight:0}});measureMarkers.push(m);
        if(clicks.length===2){if(measureLine)measureLine.setMap(null);measureLine=new google.maps.Polyline({path:clicks,map,strokeColor:'#111',strokeOpacity:.9,strokeWeight:4});
          const meters=google.maps.geometry.spherical.computeLength(measureLine.getPath());showNote(`<b>Distancia:</b> ${meters.toFixed(1)} m`);clicks=[]}})}
    function cropToLastMeters(m=800){if(P.length<2||!map)return;const total=cumDist[cumDist.length-1]||0,target=Math.max(0,total-m);let start=0;for(let i=cumDist.length-1;i>=0;i--){if(cumDist[i]<=target){start=i;break}}
      const crop=P.slice(start).map(p=>({lat:p.lat,lng:p.lng}));const pl=new google.maps.Polyline({path:crop,map,strokeColor:'#111',strokeOpacity:.5,strokeWeight:8});
      const bounds=crop.reduce((b,c)=>{if(!b)return new google.maps.LatLngBounds(c,c);return b.extend(c)},null);if(bounds)map.fitBounds(bounds);showNote(`Vista recortada a últimos ${m} m (aprox.).`,2500)}
  </script>

  
  <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBbU0AWOuYLB3iv_KBehIlDvmbZ6x3iD1M&amp;callback=initMap&amp;loading=async&amp;libraries=geometry"></script>
</body>
</html>
